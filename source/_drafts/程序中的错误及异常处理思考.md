---
title: 程序中的错误及异常处理思考
date: 2020-08-28 17:54:39
tags: [Python]
category: Python
---

正式工作一年以来，经理了种种错误，当使用者在使用程序开发的系统时，偶尔会出现一些让用户不知道为什么会出现的错误，因为项目的特殊性，而面向用户也是高级别的用户时，有的时候真的有种这个错误不是我写的bug。

事情是这样的，我们有部分系统是需要依赖于其他公司提供的 API，然后我们进行定制，然后展示。而问题就在这里，如果对方的 API 时不时抽风，那么对我们的用户而言，那就是非常不好的体验。

并且，每次问题一出，开发都需要花费额外的时间来对错误进行定位，进行分析，最终确定。 所以我就在思考如果有一套良好的错误处理方式，该抛异常抛异常，使用较为简洁的语言告诉用户为什么会出错，是否会更好。

比如，现在一些公司提供的 API 大多都会提供一个错误码来告诉调用者哪里出了问题。

### 常见的错误展现方式

* 像 C 语言，基本上就是通过函数的返回值来标识是否有错，然后通过全局 errno 变量并配合一个 errstr 的数组来告诉你为什么出错。
  这种错误处理方式在大多数情况下没问题，0 表示成功，-1 表示失败，但是如果一个函数就是返回计算的结果，可能会造成语义的冲突，所以这种方式并无法包含所有，如果加入其它字段，或者再去判断其它变量，那就显得过于复杂了。
  而一旦程序忘记去检查特定的变量时，就会很容易造成 Bug， 函数接口非常不纯洁，正常值和错误值混淆在一起，导致语义有问题。

* Go 语言中的很多函数都会返回 result, err 两个值,好处是：
  函数的接口语义清晰
  如果要忽略错误，需要显示忽略，用 `_` 这样的变量来忽略，这就强制开发者决定是否处理异常
  返回的 error 是个接口， 所以可以扩展自定义的错误处理

* 资源清理
  程序出错时需要对已分配的一些资源做清理，在C语言中，可能会出现 goto fail 这样的处理，但是如果提前return返回了, 就可能造成资源泄露的问题。
  于是在 C++ 的 RAII 机制使用面向对象的特性可以很容易的处理这个事情，在构造函数中分配资源，在析构函数中释放资源。
  在 Go 语言中，可以使用 defer 关键字做到同样 C++ 的效果。

* 异常捕获处理

  对比一些高级语言，如 Java 的 try、catch、finally 的模式就可以同时完成异常处理及对资源的清理，Python 也类似。这样的方式也将正常代码、错误处理的代码及资源清理的代码分类，看上去也比较直观。

  * 如果真的要深入细节，那么异常捕获对程序的性能是有一定影响的，一旦异常抛出了，函数就跟着 return 了。而程序在执行时需要处理函数栈的上下文，这会导致性能变得很慢，尤其是函数栈比较深的时候。
  * 而另一方面，异常的抛出基本上表名程序的错误，大多数情况下，应该是在没有异常的情况下运行的，所以有异常的情况是极少数，不会影响正常处理的性能问题。
  * try-catch-finally 虽然很好，但是无法处理异步运行中抛出异常的问题。

* 如何选用合适的错误处理方式

  错误码和异常捕获的选择，以下说法并不一定真正合适给个参考。对于一些偏底层的错误，比如：空指针、内存不足等，可以使用返回错误状态码的方式，而对于一些上层偏业务逻辑方面的错误，可以使用异常捕获。

  * 在这里学习一个大牛的分析方式

    要讨论场景使用，我们需要先把要处理的错误分好类别，这样有利于简化问题。因为错误其实是很多的，不同的错误需要不同的处理方式。但错误处理是有一些通用规则的。我们将错误分为以下几类：

    **资源错误**：当我们的代码去请求一些资源时，导致的错误，比如打开一个没有权限的文件，写文件时出现的写错误，发送文件到网络端发现网络故障的错误，等等。这一类错误属于程序运行环境的问题。对于这类错误，有的我们可以处理，有的我们无法处理。比如内存耗尽、栈溢出或是一些程序运行时关键性资源不能满足等等这些情况，我们只能停止运行，甚至退出整个程序。

    **程序的错误**:  比如空指针、非法参数等。这类是我们自己程序的错误，我们要记录下来，写入日志，最好触发监控系统报警。

    **用户的错误：** 比如 Bad Request、 Bad Format 等这类由用户不合法输入带来的错误。这类错误基本上是在用户的 API 层上出现的问题。比如，解析一个 XML 或 JSON 文件，或者用户输入的字段不合法之类的。对于这类错误，我们需要向用户端报错，让用户自己处理修正他们的输入或操作。然后，我们正常执行，但是需要做停机，统计相应的错误率，这样有利于我们改善软件或是侦测是否有恶意的用户请求。

  以上三类错误，有些是我们希望杜绝发生的，比如程序的 Bug，有些则是我们杜绝不了的，比如用户的输入。而对程序运行环境中的一些错误，则是我们希望可以恢复的。也就是说，我们希望可以通过重试或是妥协的方式来解决这些环境问题，比如重建网络连接，重新打开一个新的文件。

  所以，我们可以这样在逻辑上分类：

  * 对于我们并不期望会发生的事，我们可以使用异常捕获
  * 对于我们觉得可能会发生的事情，使用返回码

  在大多数情况下，我们会混用两种报错的方式，有时候，我们还会把异常转成错误码（比如 HTTP 的 RESTful API），也会把错误码转换成异常（比如对系统调用的错误）。

  “报错的类型” 和 “错误处理” 是紧密相关的，错误处理方法多种多样，而且会在不同的层面上处理错误。有些底层错误就需要自己处理掉（比如：底层模块会自动重建网络连接），而有一些错误需要更上层的业务逻辑来处理（比如：重建网络连接不成功后，只能让上传业务来处理怎么办？降级使用本地缓存还是直接报错给用户？）

**以上仅仅适用于同步编程**



### 异步编程中的错误处理

* 无法使用返回码

  在异步编程中，因为被调用的函数是被放到了另外一个线程里运行，所谓的返回只是把处理权交给下一条指令，而不是把函数运行完的结果返回。所以，函数返回的语义完全变了，返回码也没有用了。

* 无法使用抛异常的方式

  抛出的异常也在另外一个线程中，不同线程中的栈是完全不一样的，所以主线程的 catch 完全看不到另外一个线程中的异常。

在异步编程中，最常见的就是 callback 方式。在做异步请求的时候，注册几个 OnSuccess()、 OnFailure() 这样的函数，让在另一个现场中运行的异步代码来回调过来。比如 JavaScript 中异步编程错误的处理。

这样出错的语义就从返回码、异常捕获到了直接耦合错误出处函数的样子，但是这样也会出现 Callback Hell 的问题。不过，可以使用 Promise 模式来处理。在ECMAScript 2017 的标准中，我们可以使用 async/await 这两个关键字来取代 Promise 对象，这样可以让我们的代码更易读。

在其他语言中，如 Go 语言，也有类似的错误处理方式。



#### 错误处理最佳实践

* 统一分类的错误字典：无论是使用错误码还是异常捕获，都需要认真并统一做好错误的分类。最好是在一个地方定义相关的错误。比如，HTTP 的 4XX 表示客户端有问题，5XX 表示服务端有问题。也就是说，要建立一个错误字典。
* 同类错误的定义最好是可以扩展的：这一点很重要，通过面向对象的继承可以很好做到，这样可以方便地重用已有代码。
* 定义错误的严重程度：Fatal 表示重大错误，Error 表示自愿或需求得不到满足， Warning 表示并不一定是个错误但还是要引起注意，Info 表示不是错误只是一个信息， Debug 表示这是给内部开发人员用于调试程序的。
* 错误日志的输出最好使用错误码，而不是错误信息。打印错误日志的时候，应该使用同一的格式。但最好不要用错误信息，而应使用相应的错误码，错误码不一定是数字，也可以是一个能从错误字典里找到的一个唯一可以让人读懂的关键字。这样，会非常有利于日志分析软件进行自动化监控，而不是要从错误字典里找到一个唯一的可以让人读懂的关键字。这样的返回码如 404。但是更推荐像 PageNotFound 这样的标识，这样人和机器都很容易处理。
* 忽略错误最好有日志： 不然会给维护带来很大的麻烦
* 对于同一个地方不停的报错，最好不要都打到日志里：不然这样会导致其它日志被淹没了，也会导致日志文件太大。最好的实践是，大厨一个错误以及出现的次数。
* 不要用错误处理逻辑来处理业务逻辑：也就是说，不要使用异常捕获的方式来处理业务逻辑，而是应该用条件判断。如果一个逻辑控制可以使用 if-else 清楚的表达，那就不建议使用异常方式处理。异常捕获是用来处理不期望发生的事情，而错误码是用来处理可能会发生的事。
* 对于同类的错误处理，用样的模式，比如 null 对象的错误，要么都返回 null，加上条件检查的模式，要么都用抛 NullPointerException 的方式处理。不要混用，有助于代码规范
* 尽可能在错误发生的地方处理错误：因为这样会让调用者变得更简单。
* 向上尽可能地返回原始的错误：如果一定要把错误返回到更高层去处理，那么，应该返回原始的错误，而不是重新发明一个错误
* 处理错误时，总是要清理已分配的资源。
* 不推荐在循环体里处理错误：这里说的是 try-catch，绝大多数的情况你不需要这样做。最好把整个循环体放在 try 语句块内，而在外面做 catch。
* 不要把大量的代码都放在一个 try 语句块内。一个 try 语句块内的语句应该是完成一个简单单一的事情。
* 为你的错误定义提供清除的文档以及每种错误的代码示例：如果你是做 RESTful API 方面的，使用 Swagger 会帮你很容易搞定这个事情。
* 对于异步的方式，推荐使用 Promise 模式处理错误。
* 对于分布式的系统，推荐使用 APM 相关的软件。尤其是使用 Zipkin 这样的服务调用跟踪的分析来关联错误。

参考：

[陈皓--左耳听风](#)















